"use strict";var e=require("./subfile-f9b9aa56.js"),t=require("fs"),s=require("archiver");function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}require("moment");var a=i(t),o=i(s);module.exports=class{metadata;generateContentsCallback;coverImage;showContents;sections;css;filesForTOC;images;runtime;constructor(e){this.metadata={},this.coverImage={},this.showContents=!0,this.sections=[],this.css="",this.filesForTOC=[],this.images=[],this.runtime="node",e&&this.setMeta(e)}_verify(){const t=["id","title","author","cover"];if(e.isEmptyObj(this.metadata))throw new Error("Missing metadata, You can use the setMeta function to set it.");{const e=this.metadata;t.forEach((t=>{const s=e[t];if(null==s||void 0===s||""===s.toString().trim())throw new Error(`Missing required metadata: ${t}`)}))}}setMeta(e){Object.assign(this.metadata,e),Object.assign(this.showContents,e.showContents),e.cover&&this.addCover(e.cover),e.images&&this.addImagesAll(e.images)}addCover(t){this.coverImage="string"==typeof t?{name:e.getImageFileName(t),data:t}:t}setContents(e){this.generateContentsCallback=e}addImage(t){this.images.push({name:e.getFileName(t),data:t})}addImagesAll(e){e.forEach((e=>{this.addImage(e)}))}addSection(e){let{title:t,overrideFilename:s,content:i,isFrontMatter:a,excludeFromContents:o}=e;if(null==s||void 0===s||""===s.toString().trim()){s=`s${this.sections.length+1}`}s=`${s}.xhtml`,this.sections.push({title:t,content:i,excludeFromContents:o||!1,isFrontMatter:a||!1,overrideFilename:s})}addSectionsAll(e){e.forEach((e=>{this.addSection(e)}))}getSectionsCount(){return this.sections.length}addCss(e){this.css=e}genUuid(){return e.genUuid()}async build(s,i){this._verify();const n=e.getFilesForEPUB(this),r=e.getFolder(s);let c=e.getFileName(s);c.endsWith(".epub")||(c+=".epub"),await t.promises.mkdir(r).catch((e=>{if(e&&"EEXIST"!==e.code)throw e}));const d=a.default.createWriteStream(`${r}/${c}`),l=o.default("zip",{store:!1});l.on("error",(e=>{throw e})),i&&l.on("progress",(e=>{i(100*e.entries.processed/n.length)})),await new Promise((async e=>{l.pipe(d),d.on("close",(()=>e(!0)));for await(let e of n){"OEBPF/images"===e.folder&&(e.content=await t.promises.readFile(e.content));const s=e.folder.length>0?`${e.folder}/${e.name}`:e.name;l.append(e.content,{name:s,store:!e.compress})}l.finalize()}))}};
