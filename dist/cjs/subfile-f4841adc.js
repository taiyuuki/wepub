"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var t=e(require("moment"));const n=e=>{const t=e.lastIndexOf("/"),n=e.lastIndexOf("\\");return Math.max(t,n)},o=function(e){const t=n(e);return t<0?e:e.substring(t+1)},i=function(e){return o("string"==typeof e?e:e.name)},s=e=>{const t=e.substring(e.lastIndexOf("."));let n="";return n=".svg"===t?"image/svg+xml":n,n=".png"===t?"image/png":n,n=".jpg"===t||".jpeg"===t?"image/jpeg":n,n=".gif"===t?"image/gif":n,n=".tif"===t||".tiff"===t?"image/tiff":n,n};function r(e){let t="";for(let n=1;n<=e;n++)t+=Math.floor(16*Math.random()).toString(16);return t}const a=(e,t,n)=>e.split(`[[${t}]]`).join(n||""),c=({metadata:e},t)=>{let n=t;return n=a(n,"COVER",i(e.cover)),n=a(n,"ID",e.id.toString()),n=a(n,"TITLE",e.title),n=a(n,"SERIES",e.series||""),n=a(n,"SEQUENCE",(e.sequence||"").toString()),n=a(n,"COPYRIGHT",e.copyright||""),n=a(n,"LANGUAGE",e.language||""),n=a(n,"FILEAS",e.fileAs||""),n=a(n,"AUTHOR",e.author||""),n=a(n,"PUBLISHER",e.publisher||""),n=a(n,"DESCRIPTION",e.description||""),n=a(n,"PUBLISHED",e.published||""),n=a(n,"GENRE",e.genre||""),n=a(n,"TAGS",e.tags||""),n=a(n,"CONTENTS",e.contents||""),n=a(n,"SOURCE",e.source||""),n=a(n,"MAKER",e.maker||"wepub"),n},l={getMimetype:()=>"application/epub+zip",getContainer:()=>{let e="";return e+="<?xml version='1.0' encoding='UTF-8' ?>\n",e+="<container version='1.0' xmlns='urn:oasis:names:tc:opendocument:xmlns:container'>\n",e+="  <rootfiles>\n",e+="    <rootfile full-path='OEBPF/ebook.opf' media-type='application/oebps-package+xml'/>\n",e+="  </rootfiles>\n",e+="</container>","<?xml version='1.0' encoding='UTF-8' ?>\n<container version='1.0' xmlns='urn:oasis:names:tc:opendocument:xmlns:container'>\n  <rootfiles>\n    <rootfile full-path='OEBPF/ebook.opf' media-type='application/oebps-package+xml'/>\n  </rootfiles>\n</container>"},getDuokanExtension(){let e="";return e+='<?xml version="1.0" encoding="UTF-8"?>\n',e+='<duokan-extension version="2.4.0">\n',e+='  <display-options layout="vertical-comic"/>\n',e+="  <writing-options>\n",e+='    <option name="writing-mode">horizontal-tb</option>\n',e+='    <option name="direction">ltr</option>\n',e+="  </writing-options>\n",e+="</duokan-extension>\n",'<?xml version="1.0" encoding="UTF-8"?>\n<duokan-extension version="2.4.0">\n  <display-options layout="vertical-comic"/>\n  <writing-options>\n    <option name="writing-mode">horizontal-tb</option>\n    <option name="direction">ltr</option>\n  </writing-options>\n</duokan-extension>\n'},getOPF:e=>{const{metadata:n}=e,r="string"==typeof e.coverImage?o(e.coverImage):o(e.coverImage.name);let a,l="";if(l+="<?xml version='1.0' encoding='utf-8'?>\n",l+="<package xmlns='http://www.idpf.org/2007/opf' version='2.0' unique-identifier='duokan-book-id'>\n",l+="  <metadata xmlns:dc='http://purl.org/dc/elements/1.1/' xmlns:opf='http://www.idpf.org/2007/opf'>\n",n.series&&n.sequence?l+=`    <dc:title>${n.title} (${n.series} #${n.sequence})</dc:title>\n`:n.series?l+=`    <dc:title>${n.title} (${n.series})</dc:title>\n`:n.sequence?l+=`    <dc:title>${n.title} (#${n.sequence})</dc:title>\n`:l+=`    <dc:title>${n.title}</dc:title>\n`,l+=`    <dc:identifier id='duokan-book-id' opf:scheme='URI'>${n.id}</dc:identifier>\n`,l+=`    <dc:language>${n.language}</dc:language>\n`,l+=`    <dc:creator opf:role='aut' opf:file-as='${n.fileAs}'>${n.author}</dc:creator>\n`,l+=`    <dc:publisher>${n.publisher}</dc:publisher>\n`,l+=`    <dc:description>${n.description}</dc:description>\n`,l+="    <dc:coverage></dc:coverage>\n",l+=`    <dc:source>${n.source}</dc:source>\n`,l+=`    <dc:date opf:event='publication'>${n.published}</dc:date>\n`,l+=`    <dc:date opf:event='modification'>${t.default().format("YYYY-MM-DD")}</dc:date>\n`,l+=`    <dc:rights>${n.copyright}</dc:rights>\n`,n.genre&&(l+=`    <dc:subject>${n.genre}</dc:subject>\n`),n.tags){const e=n.tags.split(",");for(a=0;a<e.length;a+=1)l+=`    <dc:subject>${e[a]}</dc:subject>\n`}for(n.series&&(l+=`    <meta name='calibre:series' content='${n.series}'/>\n`),n.sequence&&(l+=`    <meta name='calibre:series_index' content='${n.sequence}'/>\n"`),l+="    <meta name='cover' content='cover-image'/>\n",l+="  </metadata>\n",l+="  <manifest>\n",l+=`    <item id='cover-image' media-type='${s(r)}' href='images/${r}'/>\n`,l+="    <item id='cover' media-type='application/xhtml+xml' href='cover.xhtml'/>\n",l+="    <item id='navigation' media-type='application/x-dtbncx+xml' href='navigation.ncx'/>\n",a=1;a<=e.sections.length;a+=1){l+=`    <item id='s${a}' media-type='application/xhtml+xml' href='content/${e.sections[a-1].overrideFilename}'/>\n`}if(e.showContents&&(l+="    <item id='toc' media-type='application/xhtml+xml' href='content/toc.xhtml'/>\n"),l+="    <item id='css' media-type='text/css' href='css/ebook.css'/>\n",e.images.length>0)for(a=0;a<e.images.length;a++){const t=e.images[a],n=i(t),o=s(n);o.length>0&&(l+=`    <item id='img${a}' media-type='${o}' href='images/${n}'/>\n`)}for(l+="  </manifest>\n",l+="  <spine toc='navigation'>\n",l+="    <itemref idref='cover' linear='yes' properties='duokan-page-fullscreen'/>\n",a=1;a<=e.sections.length;a+=1)e.sections[a-1].isFrontMatter&&(l+=`    <itemref idref='s${a}' />\n`);for(e.showContents&&(l+="    <itemref idref='toc'/>\n"),a=1;a<=e.sections.length;a+=1)e.sections[a-1].isFrontMatter||(l+=`    <itemref idref='s${a}' />\n`);return l+="  </spine>\n",e.showContents&&(l+="  <guide>\n",l+="    <reference type='toc' title='Contents' href='content/toc.xhtml'></reference>\n",l+="  </guide>\n"),l+="</package>\n",c(e,c(e,l))},getNCX:e=>{let t,n,o,i="",s=1;const{metadata:r}=e;for(i+="<?xml version='1.0' encoding='UTF-8'?>\n",i+="<!DOCTYPE ncx PUBLIC '-//NISO//DTD ncx 2005-1//EN' 'http://www.daisy.org/z3986/2005/ncx-2005-1.dtd'>\n",i+="<ncx xmlns='http://www.daisy.org/z3986/2005/ncx/'>\n",i+="<head>\n",i+=`  <meta name='dtb:uid' content='${r.id}'/>\n`,i+="  <meta name='dtb:depth' content='1'/>\n",i+="  <meta name='dtb:totalPageCount' content='0'/>\n",i+="  <meta name='dtb:maxPageNumber' content='0'/>\n",i+="</head>\n",i+=`<docTitle><text>${r.title}</text></docTitle>\n`,i+=`<docAuthor><text>${r.author}</text></docAuthor>\n`,i+="<navMap>\n",i+=`  <navPoint id='cover' playOrder='${s++}'>\n`,i+="    <navLabel><text>Cover</text></navLabel>\n",i+="    <content src='cover.xhtml'/>\n",i+="  </navPoint>\n",t=1;t<=e.sections.length;t+=1)if(!e.sections[t-1].excludeFromContents&&e.sections[t-1].isFrontMatter){const r=e.sections[t-1].overrideFilename;n=e.sections[t-1].title,o=s++,e.filesForTOC.push({title:n,link:`${r}`,itemType:"front"}),i+=`  <navPoint class='section' id='s${t}' playOrder='${o}'>\n`,i+=`    <navLabel><text>${n}</text></navLabel>\n`,i+=`    <content src='content/${r}'/>\n`,i+="  </navPoint>\n"}for(e.showContents&&(e.filesForTOC.push({title:r.contents,link:"toc.xhtml",itemType:"contents"}),i+=`  <navPoint class='toc' id='toc' playOrder='${s++}'>\n`,i+="    <navLabel><text>[[CONTENTS]]</text></navLabel>\n",i+="    <content src='content/toc.xhtml'/>\n",i+="  </navPoint>\n"),t=1;t<=e.sections.length;t+=1)if(!e.sections[t-1].excludeFromContents&&!e.sections[t-1].isFrontMatter){const r=e.sections[t-1].overrideFilename;n=e.sections[t-1].title,o=s++,e.filesForTOC.push({title:n,link:`${r}`,itemType:"main"}),i+=`  <navPoint class='section' id='s${t}' playOrder='${o}'>\n`,i+=`    <navLabel><text>${n}</text></navLabel>\n`,i+=`    <content src='content/${r}'/>\n`,i+="  </navPoint>\n"}return i+="</navMap>\n",i+="</ncx>\n",c(e,c(e,i))}},d={getContents:(e,t)=>{let n="";return n+="<?xml version='1.0' encoding='utf-8'?>\n",n+="<!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.1//EN' 'http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd' >\n",n+="<html xmlns='http://www.w3.org/1999/xhtml'>\n",n+="  <head>\n",n+="    <title>[[CONTENTS]]</title>\n",n+="    <link rel='stylesheet' type='text/css' href='../css/ebook.css' />\n",n+="  </head>\n",n+="  <body>\n",t?n+=t:(n+="    <div class='contents'>\n",n+="      <h1>[[CONTENTS]]</h1>\n",e.sections.forEach((e=>{e.excludeFromContents||(n+=`      <a href='${e.overrideFilename}'>${e.title}</a><br/>\n`)})),n+="    </div>\n"),n+="  </body>\n",n+="</html>\n",n},getTOC:e=>{let t="";if(e.generateContentsCallback){const n=e.generateContentsCallback(e.filesForTOC);t=d.getContents(e,n)}else t=d.getContents(e);return c(e,c(e,t))},getCover:e=>{const t=i(e.coverImage);let n="";return n+="<?xml version='1.0' encoding='UTF-8' ?>\n",n+="<!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.1//EN'  'http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd'>\n",n+="<html xmlns='http://www.w3.org/1999/xhtml' xml:lang='en'>\n",n+="<head>\n",n+=`  <title>${e.metadata.title}</title>\n`,n+="  <style type='text/css'>\n",n+="    body { margin: 0; padding: 0; text-align: center; }\n",n+="    .cover { margin: 0; padding: 0; font-size: 1px; }\n",n+="    img { margin: 0; padding: 0; height: 100%; }\n",n+="  </style>\n",n+="</head>\n",n+="<body>\n",n+=`  <div class='cover'><img style='height: 100%;width: 100%;' src='images/${t}' alt='Cover' /></div>\n`,n+="</body>\n",n+="</html>\n",c(e,c(e,n))},getCss:e=>c(e,c(e,e.css)),getSection:(e,t)=>{const{title:n}=t,{content:o}=t;let i="";i+="<?xml version='1.0' encoding='utf-8'?>\n",i+="<!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.1//EN' 'http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd'>\n",i+="<html xmlns='http://www.w3.org/1999/xhtml'>\n",i+="  <head>\n",i+=`    <title>${n}</title>\n`,i+="    <link rel='stylesheet' type='text/css' href='../css/ebook.css' />\n",i+="  </head>\n",i+="  <body>\n",i+="    <div>\n";return o.split("\n").forEach((e=>{e.length>0&&(i+=`      ${e}\n`)})),i+="    </div>\n",i+="  </body>\n",i+="</html>\n",c(e,c(e,i))}};exports.genUuid=()=>{let e="";if("undefined"!=typeof Blob){const t=URL.createObjectURL(new Blob);e=t.toString().substring(t.lastIndexOf("/")+1),URL.revokeObjectURL(t)}else e=`${r(8)}-${r(4)}-${r(4)}-${r(4)}-${r(12)}`;return e},exports.getFileName=o,exports.getFilesForEPUB=e=>{const t=[];t.push({name:"mimetype",folder:"",compress:!1,content:l.getMimetype()}),t.push({name:"container.xml",folder:"META-INF",compress:!0,content:l.getContainer()}),t.push({name:"duokan-extension.xml",folder:"META-INF",compress:!0,content:l.getDuokanExtension()}),t.push({name:"ebook.opf",folder:"OEBPF",compress:!0,content:l.getOPF(e)}),t.push({name:"navigation.ncx",folder:"OEBPF",compress:!0,content:l.getNCX(e)}),t.push({name:"cover.xhtml",folder:"OEBPF",compress:!0,content:d.getCover(e)}),t.push({name:"ebook.css",folder:"OEBPF/css",compress:!0,content:d.getCss(e)}),e.sections.forEach((n=>{t.push({name:n.overrideFilename,folder:"OEBPF/content",compress:!0,content:d.getSection(e,n)})})),e.showContents&&t.push({name:"toc.xhtml",folder:"OEBPF/content",compress:!0,content:d.getTOC(e)});const n=i(e.coverImage),o=e.coverImage;return t.push({name:n,folder:"OEBPF/images",compress:!0,content:o.data}),e.images.length>0&&e.images.forEach((e=>{const n=e,o=i(e);t.push({name:o,folder:"OEBPF/images",compress:!0,content:n.data})})),t},exports.getFolder=function(e){const t=n(e);return e.substring(0,t)},exports.getImageFileName=i,exports.isEmptyObj=e=>0===Object.keys(e).length,exports.structural=l;
