import e from"moment";const t=e=>{const t=e.lastIndexOf("/"),n=e.lastIndexOf("\\");return Math.max(t,n)},n=function(e){const n=t(e);return n<0?e:e.substring(n+1)},o=function(e){const n=t(e);return e.substring(0,n)},i=function(e){return n("string"==typeof e?e:e.name)},s=e=>{const t=e.substring(e.lastIndexOf("."));let n="";return n=".svg"===t?"image/svg+xml":n,n=".png"===t?"image/png":n,n=".jpg"===t||".jpeg"===t?"image/jpeg":n,n=".gif"===t?"image/gif":n,n=".tif"===t||".tiff"===t?"image/tiff":n,n};function r(e){let t="";for(let n=1;n<=e;n++)t+=Math.floor(16*Math.random()).toString(16);return t}const c=()=>{let e="";if("undefined"!=typeof Blob){const t=URL.createObjectURL(new Blob);e=t.toString().substring(t.lastIndexOf("/")+1),URL.revokeObjectURL(t)}else e=`${r(8)}-${r(4)}-${r(4)}-${r(4)}-${r(12)}`;return e},a=e=>0===Object.keys(e).length,l=(e,t,n)=>e.split(`[[${t}]]`).join(n||""),m=({metadata:e},t)=>{let n=t;return n=l(n,"COVER",i(e.cover)),n=l(n,"ID",e.id.toString()),n=l(n,"TITLE",e.title),n=l(n,"SERIES",e.series||""),n=l(n,"SEQUENCE",(e.sequence||"").toString()),n=l(n,"COPYRIGHT",e.copyright||""),n=l(n,"LANGUAGE",e.language||""),n=l(n,"FILEAS",e.fileAs||""),n=l(n,"AUTHOR",e.author||""),n=l(n,"PUBLISHER",e.publisher||""),n=l(n,"DESCRIPTION",e.description||""),n=l(n,"PUBLISHED",e.published||""),n=l(n,"GENRE",e.genre||""),n=l(n,"TAGS",e.tags||""),n=l(n,"CONTENTS",e.contents||""),n=l(n,"SOURCE",e.source||""),n=l(n,"MAKER",e.maker||"wepub"),n},d={getMimetype:()=>"application/epub+zip",getContainer:()=>{let e="";return e+="<?xml version='1.0' encoding='UTF-8' ?>\n",e+="<container version='1.0' xmlns='urn:oasis:names:tc:opendocument:xmlns:container'>\n",e+="  <rootfiles>\n",e+="    <rootfile full-path='OEBPF/ebook.opf' media-type='application/oebps-package+xml'/>\n",e+="  </rootfiles>\n",e+="</container>","<?xml version='1.0' encoding='UTF-8' ?>\n<container version='1.0' xmlns='urn:oasis:names:tc:opendocument:xmlns:container'>\n  <rootfiles>\n    <rootfile full-path='OEBPF/ebook.opf' media-type='application/oebps-package+xml'/>\n  </rootfiles>\n</container>"},getDuokanExtension(){let e="";return e+='<?xml version="1.0" encoding="UTF-8"?>\n',e+='<duokan-extension version="2.4.0">\n',e+='  <display-options layout="vertical-comic"/>\n',e+="  <writing-options>\n",e+='    <option name="writing-mode">horizontal-tb</option>\n',e+='    <option name="direction">ltr</option>\n',e+="  </writing-options>\n",e+="</duokan-extension>\n",'<?xml version="1.0" encoding="UTF-8"?>\n<duokan-extension version="2.4.0">\n  <display-options layout="vertical-comic"/>\n  <writing-options>\n    <option name="writing-mode">horizontal-tb</option>\n    <option name="direction">ltr</option>\n  </writing-options>\n</duokan-extension>\n'},getOPF:t=>{const{metadata:o}=t,r="string"==typeof t.coverImage?n(t.coverImage):n(t.coverImage.name);let c,a="";if(a+="<?xml version='1.0' encoding='utf-8'?>\n",a+="<package xmlns='http://www.idpf.org/2007/opf' version='2.0' unique-identifier='duokan-book-id'>\n",a+="  <metadata xmlns:dc='http://purl.org/dc/elements/1.1/' xmlns:opf='http://www.idpf.org/2007/opf'>\n",o.series&&o.sequence?a+=`    <dc:title>${o.title} (${o.series} #${o.sequence})</dc:title>\n`:o.series?a+=`    <dc:title>${o.title} (${o.series})</dc:title>\n`:o.sequence?a+=`    <dc:title>${o.title} (#${o.sequence})</dc:title>\n`:a+=`    <dc:title>${o.title}</dc:title>\n`,a+=`    <dc:identifier id='duokan-book-id' opf:scheme='URI'>${o.id}</dc:identifier>\n`,a+=`    <dc:language>${o.language}</dc:language>\n`,a+=`    <dc:creator opf:role='aut' opf:file-as='${o.fileAs}'>${o.author}</dc:creator>\n`,a+=`    <dc:publisher>${o.publisher}</dc:publisher>\n`,a+=`    <dc:description>${o.description}</dc:description>\n`,a+="    <dc:coverage></dc:coverage>\n",a+=`    <dc:source>${o.source}</dc:source>\n`,a+=`    <dc:date opf:event='publication'>${o.published}</dc:date>\n`,a+=`    <dc:date opf:event='modification'>${e().format("YYYY-MM-DD")}</dc:date>\n`,a+=`    <dc:rights>${o.copyright}</dc:rights>\n`,o.genre&&(a+=`    <dc:subject>${o.genre}</dc:subject>\n`),o.tags){const e=o.tags.split(",");for(c=0;c<e.length;c+=1)a+=`    <dc:subject>${e[c]}</dc:subject>\n`}for(o.series&&(a+=`    <meta name='calibre:series' content='${o.series}'/>\n`),o.sequence&&(a+=`    <meta name='calibre:series_index' content='${o.sequence}'/>\n"`),a+="    <meta name='cover' content='cover-image'/>\n",a+="  </metadata>\n",a+="  <manifest>\n",a+=`    <item id='cover-image' media-type='${s(r)}' href='images/${r}'/>\n`,a+="    <item id='cover' media-type='application/xhtml+xml' href='cover.xhtml'/>\n",a+="    <item id='navigation' media-type='application/x-dtbncx+xml' href='navigation.ncx'/>\n",c=1;c<=t.sections.length;c+=1){a+=`    <item id='s${c}' media-type='application/xhtml+xml' href='content/${t.sections[c-1].overrideFilename}'/>\n`}if(t.showContents&&(a+="    <item id='toc' media-type='application/xhtml+xml' href='content/toc.xhtml'/>\n"),a+="    <item id='css' media-type='text/css' href='css/ebook.css'/>\n",t.images.length>0)for(c=0;c<t.images.length;c++){const e=t.images[c],n=i(e),o=s(n);o.length>0&&(a+=`    <item id='img${c}' media-type='${o}' href='images/${n}'/>\n`)}for(a+="  </manifest>\n",a+="  <spine toc='navigation'>\n",a+="    <itemref idref='cover' linear='yes' properties='duokan-page-fullscreen'/>\n",c=1;c<=t.sections.length;c+=1)t.sections[c-1].isFrontMatter&&(a+=`    <itemref idref='s${c}' />\n`);for(t.showContents&&(a+="    <itemref idref='toc'/>\n"),c=1;c<=t.sections.length;c+=1)t.sections[c-1].isFrontMatter||(a+=`    <itemref idref='s${c}' />\n`);return a+="  </spine>\n",t.showContents&&(a+="  <guide>\n",a+="    <reference type='toc' title='Contents' href='content/toc.xhtml'></reference>\n",a+="  </guide>\n"),a+="</package>\n",m(t,m(t,a))},getNCX:e=>{let t,n,o,i="",s=1;const{metadata:r}=e;for(i+="<?xml version='1.0' encoding='UTF-8'?>\n",i+="<!DOCTYPE ncx PUBLIC '-//NISO//DTD ncx 2005-1//EN' 'http://www.daisy.org/z3986/2005/ncx-2005-1.dtd'>\n",i+="<ncx xmlns='http://www.daisy.org/z3986/2005/ncx/'>\n",i+="<head>\n",i+=`  <meta name='dtb:uid' content='${r.id}'/>\n`,i+="  <meta name='dtb:depth' content='1'/>\n",i+="  <meta name='dtb:totalPageCount' content='0'/>\n",i+="  <meta name='dtb:maxPageNumber' content='0'/>\n",i+="</head>\n",i+=`<docTitle><text>${r.title}</text></docTitle>\n`,i+=`<docAuthor><text>${r.author}</text></docAuthor>\n`,i+="<navMap>\n",i+=`  <navPoint id='cover' playOrder='${s++}'>\n`,i+="    <navLabel><text>Cover</text></navLabel>\n",i+="    <content src='cover.xhtml'/>\n",i+="  </navPoint>\n",t=1;t<=e.sections.length;t+=1)if(!e.sections[t-1].excludeFromContents&&e.sections[t-1].isFrontMatter){const r=e.sections[t-1].overrideFilename;n=e.sections[t-1].title,o=s++,e.filesForTOC.push({title:n,link:`${r}`,itemType:"front"}),i+=`  <navPoint class='section' id='s${t}' playOrder='${o}'>\n`,i+=`    <navLabel><text>${n}</text></navLabel>\n`,i+=`    <content src='content/${r}'/>\n`,i+="  </navPoint>\n"}for(e.showContents&&(e.filesForTOC.push({title:r.contents,link:"toc.xhtml",itemType:"contents"}),i+=`  <navPoint class='toc' id='toc' playOrder='${s++}'>\n`,i+="    <navLabel><text>[[CONTENTS]]</text></navLabel>\n",i+="    <content src='content/toc.xhtml'/>\n",i+="  </navPoint>\n"),t=1;t<=e.sections.length;t+=1)if(!e.sections[t-1].excludeFromContents&&!e.sections[t-1].isFrontMatter){const r=e.sections[t-1].overrideFilename;n=e.sections[t-1].title,o=s++,e.filesForTOC.push({title:n,link:`${r}`,itemType:"main"}),i+=`  <navPoint class='section' id='s${t}' playOrder='${o}'>\n`,i+=`    <navLabel><text>${n}</text></navLabel>\n`,i+=`    <content src='content/${r}'/>\n`,i+="  </navPoint>\n"}return i+="</navMap>\n",i+="</ncx>\n",m(e,m(e,i))}},p={getContents:(e,t)=>{let n="";return n+="<?xml version='1.0' encoding='utf-8'?>\n",n+="<!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.1//EN' 'http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd' >\n",n+="<html xmlns='http://www.w3.org/1999/xhtml'>\n",n+="  <head>\n",n+="    <title>[[CONTENTS]]</title>\n",n+="    <link rel='stylesheet' type='text/css' href='../css/ebook.css' />\n",n+="  </head>\n",n+="  <body>\n",t?n+=t:(n+="    <div class='contents'>\n",n+="      <h1>[[CONTENTS]]</h1>\n",e.sections.forEach((e=>{e.excludeFromContents||(n+=`      <a href='${e.overrideFilename}'>${e.title}</a><br/>\n`)})),n+="    </div>\n"),n+="  </body>\n",n+="</html>\n",n},getTOC:e=>{let t="";if(e._generateContentsCallback){const n=e._generateContentsCallback(e.filesForTOC);t=p.getContents(e,n)}else t=p.getContents(e);return m(e,m(e,t))},getCover:e=>{const t=i(e.coverImage);let n="";return n+="<?xml version='1.0' encoding='UTF-8' ?>\n",n+="<!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.1//EN'  'http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd'>\n",n+="<html xmlns='http://www.w3.org/1999/xhtml' xml:lang='en'>\n",n+="<head>\n",n+=`  <title>${e.metadata.title}</title>\n`,n+="  <style type='text/css'>\n",n+="    body { margin: 0; padding: 0; text-align: center; }\n",n+="    .cover { margin: 0; padding: 0; font-size: 1px; }\n",n+="    img { margin: 0; padding: 0; height: 100%; }\n",n+="  </style>\n",n+="</head>\n",n+="<body>\n",n+=`  <div class='cover'><img style='height: 100%;width: 100%;' src='images/${t}' alt='Cover' /></div>\n`,n+="</body>\n",n+="</html>\n",m(e,m(e,n))},getCss:e=>m(e,m(e,e.css)),getSection:(e,t)=>{const{title:n}=t,{content:o}=t;let i="";i+="<?xml version='1.0' encoding='utf-8'?>\n",i+="<!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.1//EN' 'http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd'>\n",i+="<html xmlns='http://www.w3.org/1999/xhtml'>\n",i+="  <head>\n",i+=`    <title>${n}</title>\n`,i+="    <link rel='stylesheet' type='text/css' href='../css/ebook.css' />\n",i+="  </head>\n",i+="  <body>\n",i+="    <div>\n";return o.split("\n").forEach((e=>{e.length>0&&(i+=`      ${e}\n`)})),i+="    </div>\n",i+="  </body>\n",i+="</html>\n",m(e,m(e,i))}},g=e=>{const t=[];e.customFile.length>0&&e.customFile.forEach((e=>{t.push({name:e.name,folder:e.folder,compress:e.compress??!0,content:e.content})})),t.push({name:"mimetype",folder:"",compress:!1,content:d.getMimetype()}),t.push({name:"container.xml",folder:"META-INF",compress:!0,content:d.getContainer()}),t.push({name:"ebook.opf",folder:"OEBPF",compress:!0,content:d.getOPF(e)}),t.push({name:"navigation.ncx",folder:"OEBPF",compress:!0,content:d.getNCX(e)}),t.push({name:"cover.xhtml",folder:"OEBPF",compress:!0,content:p.getCover(e)}),t.push({name:"ebook.css",folder:"OEBPF/css",compress:!0,content:p.getCss(e)}),e.sections.forEach((n=>{t.push({name:n.overrideFilename,folder:"OEBPF/content",compress:!0,content:p.getSection(e,n)})})),e.showContents&&t.push({name:"toc.xhtml",folder:"OEBPF/content",compress:!0,content:p.getTOC(e)});const n=i(e.coverImage),o=e.coverImage;return t.push({name:n,folder:"OEBPF/images",compress:!0,content:o.data}),e.images.length>0&&e.images.forEach((e=>{const n=e,o=i(e);t.push({name:o,folder:"OEBPF/images",compress:!0,content:n.data})})),t};export{n as a,c as b,g as c,o as d,i as g,a as i,d as s};
